<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fingerprints Explorer - Woofalytics</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/styles.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üêï</text></svg>">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        /* ===== Fingerprints Explorer Page ===== */

        .fingerprints-page {
            --card-bg: rgba(22, 27, 34, 0.6);
            --card-bg-hover: rgba(28, 33, 40, 0.8);
            --badge-success-bg: rgba(16, 185, 129, 0.12);
            --badge-success-border: rgba(16, 185, 129, 0.25);
            --badge-success-text: #10b981;
            --badge-warning-bg: rgba(245, 158, 11, 0.12);
            --badge-warning-border: rgba(245, 158, 11, 0.25);
            --badge-warning-text: #f59e0b;
            --badge-muted-bg: rgba(100, 116, 139, 0.12);
            --badge-muted-border: rgba(100, 116, 139, 0.25);
            --badge-muted-text: #64748b;
        }

        /* Stats Row */
        .stats-row {
            display: flex;
            gap: var(--space-md);
            margin-bottom: var(--space-lg);
            padding: var(--space-md) var(--space-lg);
            background: var(--card-bg);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-lg);
            backdrop-filter: blur(20px);
            flex-wrap: wrap;
        }

        .stat-pill {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            padding: var(--space-xs) var(--space-md);
            background: var(--bg-overlay);
            border-radius: var(--radius-full);
        }

        .stat-pill-value {
            font-size: 1.25rem;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-primary);
        }

        .stat-pill-label {
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        .stat-pill--total .stat-pill-value { color: var(--accent-teal); }
        .stat-pill--tagged .stat-pill-value { color: var(--accent-amber); }
        .stat-pill--untagged .stat-pill-value { color: var(--accent-coral); }
        .stat-pill--dogs .stat-pill-value { color: var(--accent-blue); }

        /* Main Layout */
        .fingerprints-layout {
            display: flex;
            flex-direction: column;
            gap: var(--space-lg);
            flex: 1;
        }

        /* Section Panels */
        .fp-section {
            display: flex;
            flex-direction: column;
            background: var(--card-bg);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-lg);
            backdrop-filter: blur(20px);
            overflow: hidden;
        }

        .fp-section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-md) var(--space-lg);
            border-bottom: 1px solid var(--border-muted);
            background: rgba(0, 0, 0, 0.2);
            flex-wrap: wrap;
            gap: var(--space-sm);
        }

        .fp-section-title {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .fp-section-title svg {
            width: 18px;
            height: 18px;
            color: var(--accent-teal);
        }

        .fp-section-body {
            flex: 1;
            padding: var(--space-md);
            overflow-x: auto;
        }

        /* Filters Bar */
        .filters-bar {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .filter-label {
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
        }

        .filter-select {
            padding: var(--space-xs) var(--space-sm);
            background: var(--bg-overlay);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-size: 0.8rem;
            cursor: pointer;
            min-width: 120px;
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--accent-teal);
        }

        .filter-input {
            padding: var(--space-xs) var(--space-sm);
            background: var(--bg-overlay);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-size: 0.8rem;
            width: 140px;
        }

        .filter-input:focus {
            outline: none;
            border-color: var(--accent-teal);
        }

        .filter-toggle {
            display: flex;
            background: var(--bg-overlay);
            border-radius: var(--radius-sm);
            overflow: hidden;
            border: 1px solid var(--border-default);
        }

        .filter-toggle-btn {
            padding: var(--space-xs) var(--space-md);
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .filter-toggle-btn:hover {
            color: var(--text-secondary);
        }

        .filter-toggle-btn.active {
            background: var(--accent-teal);
            color: var(--bg-base);
        }

        .btn-filter-reset {
            padding: var(--space-xs) var(--space-sm);
            background: transparent;
            border: 1px solid var(--border-default);
            border-radius: var(--radius-sm);
            color: var(--text-muted);
            font-size: 0.75rem;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .btn-filter-reset:hover {
            background: var(--bg-overlay);
            color: var(--text-primary);
        }

        /* Data Table */
        .fp-table-container {
            overflow-x: auto;
        }

        .fp-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .fp-table th {
            text-align: left;
            padding: var(--space-sm) var(--space-md);
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            border-bottom: 1px solid var(--border-default);
            white-space: nowrap;
            cursor: pointer;
            user-select: none;
            transition: color var(--transition-fast);
        }

        .fp-table th:hover {
            color: var(--text-secondary);
        }

        .fp-table th.sorted {
            color: var(--accent-teal);
        }

        .fp-table th .sort-icon {
            display: inline-block;
            margin-left: 4px;
            opacity: 0.5;
        }

        .fp-table th.sorted .sort-icon {
            opacity: 1;
        }

        .fp-table td {
            padding: var(--space-sm) var(--space-md);
            border-bottom: 1px solid var(--border-muted);
            color: var(--text-secondary);
            white-space: nowrap;
        }

        .fp-table tbody tr {
            transition: background var(--transition-fast);
        }

        .fp-table tbody tr:hover {
            background: var(--bg-overlay);
        }

        .fp-table .mono {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
        }

        /* Dog Tag in Table */
        .dog-tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 10px;
            background: var(--accent-amber-dim);
            color: var(--accent-amber);
            border-radius: var(--radius-full);
            font-size: 0.75rem;
            font-weight: 600;
        }

        .dog-tag--unknown {
            background: var(--badge-muted-bg);
            color: var(--badge-muted-text);
        }

        /* Confidence Badge */
        .confidence-badge {
            display: inline-flex;
            padding: 2px 8px;
            border-radius: var(--radius-full);
            font-size: 0.75rem;
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
        }

        .confidence-badge--high {
            background: var(--badge-success-bg);
            color: var(--badge-success-text);
        }

        .confidence-badge--medium {
            background: var(--badge-warning-bg);
            color: var(--badge-warning-text);
        }

        .confidence-badge--low {
            background: var(--badge-muted-bg);
            color: var(--badge-muted-text);
        }

        /* Action Buttons */
        .action-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            background: transparent;
            border: 1px solid var(--border-default);
            border-radius: var(--radius-sm);
            color: var(--text-muted);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .action-btn:hover {
            background: var(--bg-overlay);
            color: var(--text-primary);
            border-color: var(--accent-teal);
        }

        .action-btn svg {
            width: 14px;
            height: 14px;
        }

        .action-btn--play:hover {
            border-color: var(--accent-amber);
            color: var(--accent-amber);
        }

        /* Pagination */
        .pagination {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-md) var(--space-lg);
            border-top: 1px solid var(--border-muted);
            background: rgba(0, 0, 0, 0.1);
        }

        .pagination-info {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .pagination-controls {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .pagination-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            background: var(--bg-overlay);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .pagination-btn:hover:not(:disabled) {
            background: var(--accent-teal-dim);
            border-color: var(--accent-teal);
            color: var(--accent-teal);
        }

        .pagination-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .pagination-btn svg {
            width: 16px;
            height: 16px;
        }

        .pagination-page {
            padding: var(--space-xs) var(--space-md);
            font-size: 0.8rem;
            color: var(--text-secondary);
            font-family: 'JetBrains Mono', monospace;
        }

        /* Charts Section */
        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-lg);
        }

        @media (max-width: 900px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }

        .chart-panel {
            background: var(--card-bg);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            backdrop-filter: blur(20px);
        }

        .chart-title {
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-secondary);
            margin-bottom: var(--space-md);
        }

        .chart-container {
            position: relative;
            height: 250px;
        }

        /* Timeline View */
        .timeline-container {
            padding: var(--space-md) 0;
            overflow-x: auto;
        }

        .timeline {
            display: flex;
            align-items: center;
            min-height: 60px;
            position: relative;
            padding: var(--space-md) 0;
        }

        .timeline-track {
            position: absolute;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--border-default);
            top: 50%;
            transform: translateY(-50%);
        }

        .timeline-event {
            position: absolute;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--accent-teal);
            cursor: pointer;
            transition: all var(--transition-fast);
            transform: translateY(-50%);
            top: 50%;
        }

        .timeline-event:hover {
            transform: translateY(-50%) scale(1.3);
            box-shadow: 0 0 12px var(--accent-teal);
        }

        .timeline-event--tagged {
            background: var(--accent-amber);
        }

        .timeline-event--tagged:hover {
            box-shadow: 0 0 12px var(--accent-amber);
        }

        .timeline-labels {
            display: flex;
            justify-content: space-between;
            padding: var(--space-sm) 0;
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        /* Empty State */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: var(--space-2xl) var(--space-lg);
            text-align: center;
        }

        .empty-state-icon {
            width: 48px;
            height: 48px;
            margin-bottom: var(--space-md);
            color: var(--text-muted);
            opacity: 0.4;
        }

        .empty-state-text {
            font-size: 0.875rem;
            color: var(--text-muted);
            line-height: 1.5;
        }

        /* Loading State */
        .loading-state {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-sm);
            padding: var(--space-xl);
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid var(--border-default);
            border-top-color: var(--accent-teal);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Audio Player (Inline) */
        .audio-player {
            display: none;
            position: fixed;
            bottom: var(--space-lg);
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-surface);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-lg);
            padding: var(--space-md) var(--space-lg);
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            gap: var(--space-md);
            align-items: center;
        }

        .audio-player.active {
            display: flex;
        }

        .audio-player audio {
            max-width: 300px;
        }

        .audio-player-close {
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: var(--space-xs);
        }

        .audio-player-close:hover {
            color: var(--text-primary);
        }

        /* Evidence Browser */
        .evidence-section {
            background: var(--bg-surface);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-lg);
            overflow: hidden;
        }

        .evidence-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-md) var(--space-lg);
            border-bottom: 1px solid var(--border-muted);
        }

        .evidence-title {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .evidence-list {
            display: flex;
            flex-direction: column;
            max-height: 300px;
            overflow-y: auto;
        }

        .evidence-item {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            padding: var(--space-sm) var(--space-lg);
            border-bottom: 1px solid var(--border-muted);
            transition: background var(--transition-fast);
        }

        .evidence-item:last-child {
            border-bottom: none;
        }

        .evidence-item:hover {
            background: var(--bg-overlay);
        }

        .evidence-play-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            background: var(--accent-amber-dim);
            border: 1px solid var(--accent-amber);
            border-radius: 50%;
            color: var(--accent-amber);
            cursor: pointer;
            transition: all var(--transition-fast);
            flex-shrink: 0;
        }

        .evidence-play-btn:hover {
            background: var(--accent-amber);
            color: var(--bg-surface);
            transform: scale(1.1);
        }

        .evidence-play-btn.playing {
            animation: pulse-amber 1s ease-in-out infinite;
        }

        @keyframes pulse-amber {
            0%, 100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.4); }
            50% { box-shadow: 0 0 0 8px rgba(245, 158, 11, 0); }
        }

        .evidence-info {
            flex: 1;
            min-width: 0;
        }

        .evidence-time {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            color: var(--text-primary);
        }

        .evidence-meta {
            display: flex;
            gap: var(--space-md);
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .evidence-meta-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .evidence-empty {
            padding: var(--space-xl);
            text-align: center;
            color: var(--text-muted);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .stats-row {
                gap: var(--space-sm);
            }

            .filters-bar {
                flex-direction: column;
                align-items: stretch;
            }

            .filter-group {
                width: 100%;
            }

            .filter-select, .filter-input {
                flex: 1;
            }

            .fp-table {
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body class="fingerprints-page">
    <!-- Telemetry Strip -->
    <div class="telemetry-strip">
        <div class="telemetry-mission">
            <span class="mission-badge">WOOFALYTICS</span>
            <span class="mission-callsign">FINGERPRINTS EXPLORER</span>
        </div>
        <div class="telemetry-status">
            <a href="/" class="btn-sm btn-outline" style="text-decoration: none;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
                Dashboard
            </a>
            <a href="/dogs.html" class="btn-sm btn-outline" style="text-decoration: none; margin-left: 8px;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px">
                    <circle cx="12" cy="12" r="10"/>
                    <path d="M8 14s1.5 2 4 2 4-2 4-2"/>
                </svg>
                Dogs
            </a>
        </div>
    </div>

    <div class="app">
        <header class="header">
            <div class="brand">
                <svg class="brand-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 11c0 3.517-1.009 6.799-2.753 9.571m-3.44-2.04l.054-.09A13.916 13.916 0 008 11a4 4 0 118 0c0 1.017-.07 2.019-.203 3m-2.118 6.844A21.88 21.88 0 0015.171 17m3.839 1.132c.645-2.266.99-4.659.99-7.132A8 8 0 008 4.07M3 15.364c.64-1.319 1-2.8 1-4.364 0-1.457.39-2.823 1.07-4"/>
                </svg>
                <h1>Fingerprints Explorer</h1>
            </div>
        </header>

        <!-- Stats Row -->
        <div class="stats-row">
            <div class="stat-pill stat-pill--total">
                <span class="stat-pill-value" id="stat-total">0</span>
                <span class="stat-pill-label">Total Fingerprints</span>
            </div>
            <div class="stat-pill stat-pill--tagged">
                <span class="stat-pill-value" id="stat-tagged">0</span>
                <span class="stat-pill-label">Tagged</span>
            </div>
            <div class="stat-pill stat-pill--untagged">
                <span class="stat-pill-value" id="stat-untagged">0</span>
                <span class="stat-pill-label">Untagged</span>
            </div>
            <div class="stat-pill stat-pill--dogs">
                <span class="stat-pill-value" id="stat-dogs">0</span>
                <span class="stat-pill-label">Dogs</span>
            </div>
        </div>

        <main class="fingerprints-layout">
            <!-- Timeline Section -->
            <section class="fp-section" id="timeline-section">
                <div class="fp-section-header">
                    <h2 class="fp-section-title">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <polyline points="12 6 12 12 16 14"/>
                        </svg>
                        Timeline (Last 24 Hours)
                    </h2>
                </div>
                <div class="fp-section-body">
                    <div class="timeline-container" id="timeline-container">
                        <div class="timeline" id="timeline">
                            <div class="timeline-track"></div>
                        </div>
                        <div class="timeline-labels">
                            <span id="timeline-start">--</span>
                            <span id="timeline-end">Now</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Fingerprints Table Section -->
            <section class="fp-section">
                <div class="fp-section-header">
                    <h2 class="fp-section-title">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 11c0 3.517-1.009 6.799-2.753 9.571m-3.44-2.04l.054-.09A13.916 13.916 0 008 11a4 4 0 118 0c0 1.017-.07 2.019-.203 3m-2.118 6.844A21.88 21.88 0 0015.171 17m3.839 1.132c.645-2.266.99-4.659.99-7.132A8 8 0 008 4.07M3 15.364c.64-1.319 1-2.8 1-4.364 0-1.457.39-2.823 1.07-4"/>
                        </svg>
                        Fingerprints
                    </h2>
                    <div class="filters-bar">
                        <div class="filter-group">
                            <label class="filter-label">Dog</label>
                            <select class="filter-select" id="filter-dog">
                                <option value="">All Dogs</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Status</label>
                            <div class="filter-toggle">
                                <button class="filter-toggle-btn active" data-filter="all">All</button>
                                <button class="filter-toggle-btn" data-filter="tagged">Tagged</button>
                                <button class="filter-toggle-btn" data-filter="untagged">Untagged</button>
                            </div>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">From</label>
                            <input type="date" class="filter-input" id="filter-date-start">
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">To</label>
                            <input type="date" class="filter-input" id="filter-date-end">
                        </div>
                        <button class="btn-filter-reset" id="btn-reset-filters">Reset</button>
                    </div>
                </div>
                <div class="fp-section-body">
                    <div class="fp-table-container">
                        <table class="fp-table" id="fingerprints-table">
                            <thead>
                                <tr>
                                    <th data-sort="timestamp" class="sorted">
                                        Timestamp <span class="sort-icon">&#9660;</span>
                                    </th>
                                    <th data-sort="dog">Dog</th>
                                    <th data-sort="confidence">Confidence</th>
                                    <th data-sort="duration">Duration</th>
                                    <th data-sort="pitch">Pitch</th>
                                    <th data-sort="direction">Direction</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="fingerprints-tbody">
                                <tr>
                                    <td colspan="7">
                                        <div class="loading-state">
                                            <div class="spinner"></div>
                                            <span>Loading fingerprints...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="pagination">
                    <div class="pagination-info" id="pagination-info">
                        Showing 0-0 of 0
                    </div>
                    <div class="pagination-controls">
                        <button class="pagination-btn" id="btn-prev" disabled>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="15 18 9 12 15 6"/>
                            </svg>
                        </button>
                        <span class="pagination-page" id="pagination-page">Page 1</span>
                        <button class="pagination-btn" id="btn-next" disabled>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="9 18 15 12 9 6"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </section>

            <!-- Evidence Browser -->
            <section class="evidence-section">
                <div class="evidence-header">
                    <h2 class="evidence-title">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                            <polygon points="5 3 19 12 5 21 5 3"/>
                        </svg>
                        Recent Recordings
                    </h2>
                    <span class="text-muted" id="evidence-count">Loading...</span>
                </div>
                <div class="evidence-list" id="evidence-list">
                    <div class="evidence-empty">Loading recordings...</div>
                </div>
            </section>

            <!-- Charts Section -->
            <div class="charts-grid">
                <div class="chart-panel">
                    <h3 class="chart-title">Pitch Distribution by Dog</h3>
                    <div class="chart-container">
                        <canvas id="pitch-chart"></canvas>
                    </div>
                </div>
                <div class="chart-panel">
                    <h3 class="chart-title">Duration by Dog</h3>
                    <div class="chart-container">
                        <canvas id="duration-chart"></canvas>
                    </div>
                </div>
            </div>
        </main>

        <footer class="footer">
            <span>Woofalytics v2.0.0</span>
            <span class="footer-divider">¬∑</span>
            <a href="/">Dashboard</a>
            <span class="footer-divider">¬∑</span>
            <a href="/dogs.html">Manage Dogs</a>
            <span class="footer-divider">¬∑</span>
            <a href="/api/docs">API Documentation</a>
        </footer>
    </div>

    <!-- Audio Player -->
    <div class="audio-player" id="audio-player">
        <audio controls id="audio-element"></audio>
        <button class="audio-player-close" onclick="closeAudioPlayer()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                <line x1="18" y1="6" x2="6" y2="18"/>
                <line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
        </button>
    </div>

    <script>
    /**
     * Fingerprints Explorer
     */
    class FingerprintsExplorer {
        constructor() {
            this.fingerprints = [];
            this.dogs = [];
            this.currentPage = 1;
            this.pageSize = 50;
            this.totalCount = 0;
            this.sortColumn = 'timestamp';
            this.sortDirection = 'desc';
            this.filters = {
                dog_id: '',
                tagged: null,
                date_start: '',
                date_end: ''
            };
            this.pitchChart = null;
            this.durationChart = null;
            this.init();
        }

        async init() {
            await this.loadDogs();
            await this.loadStats();
            await this.loadFingerprints();
            await this.loadAggregates();
            await this.loadEvidence();
            this.loadTimeline();
            this.setupEventListeners();

            // Refresh every 60 seconds
            setInterval(() => {
                this.loadStats();
                this.loadFingerprints();
                this.loadEvidence();
                this.loadTimeline();
            }, 60000);
        }

        setupEventListeners() {
            // Dog filter
            document.getElementById('filter-dog').addEventListener('change', (e) => {
                this.filters.dog_id = e.target.value;
                this.currentPage = 1;
                this.loadFingerprints();
            });

            // Tagged/Untagged toggle
            document.querySelectorAll('.filter-toggle-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.filter-toggle-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    const filter = e.target.dataset.filter;
                    if (filter === 'all') {
                        this.filters.tagged = null;
                    } else if (filter === 'tagged') {
                        this.filters.tagged = true;
                    } else {
                        this.filters.tagged = false;
                    }
                    this.currentPage = 1;
                    this.loadFingerprints();
                });
            });

            // Date filters
            document.getElementById('filter-date-start').addEventListener('change', (e) => {
                this.filters.date_start = e.target.value;
                this.currentPage = 1;
                this.loadFingerprints();
            });

            document.getElementById('filter-date-end').addEventListener('change', (e) => {
                this.filters.date_end = e.target.value;
                this.currentPage = 1;
                this.loadFingerprints();
            });

            // Reset filters
            document.getElementById('btn-reset-filters').addEventListener('click', () => {
                this.filters = { dog_id: '', tagged: null, date_start: '', date_end: '' };
                document.getElementById('filter-dog').value = '';
                document.getElementById('filter-date-start').value = '';
                document.getElementById('filter-date-end').value = '';
                document.querySelectorAll('.filter-toggle-btn').forEach(b => b.classList.remove('active'));
                document.querySelector('.filter-toggle-btn[data-filter="all"]').classList.add('active');
                this.currentPage = 1;
                this.loadFingerprints();
            });

            // Pagination
            document.getElementById('btn-prev').addEventListener('click', () => {
                if (this.currentPage > 1) {
                    this.currentPage--;
                    this.loadFingerprints();
                }
            });

            document.getElementById('btn-next').addEventListener('click', () => {
                const maxPage = Math.ceil(this.totalCount / this.pageSize);
                if (this.currentPage < maxPage) {
                    this.currentPage++;
                    this.loadFingerprints();
                }
            });

            // Sorting
            document.querySelectorAll('.fp-table th[data-sort]').forEach(th => {
                th.addEventListener('click', () => {
                    const column = th.dataset.sort;
                    if (this.sortColumn === column) {
                        this.sortDirection = this.sortDirection === 'asc' ? 'desc' : 'asc';
                    } else {
                        this.sortColumn = column;
                        this.sortDirection = 'desc';
                    }
                    this.updateSortUI();
                    this.loadFingerprints();
                });
            });
        }

        updateSortUI() {
            document.querySelectorAll('.fp-table th[data-sort]').forEach(th => {
                th.classList.remove('sorted');
                const icon = th.querySelector('.sort-icon');
                if (icon) icon.innerHTML = '&#9660;';
            });
            const sortedTh = document.querySelector(`.fp-table th[data-sort="${this.sortColumn}"]`);
            if (sortedTh) {
                sortedTh.classList.add('sorted');
                const icon = sortedTh.querySelector('.sort-icon');
                if (icon) {
                    icon.innerHTML = this.sortDirection === 'asc' ? '&#9650;' : '&#9660;';
                }
            }
        }

        async loadStats() {
            try {
                const response = await fetch('/api/fingerprints/stats');
                if (!response.ok) return;
                const data = await response.json();

                document.getElementById('stat-total').textContent = data.fingerprints || 0;
                document.getElementById('stat-tagged').textContent = data.tagged || 0;
                document.getElementById('stat-untagged').textContent = data.untagged || 0;
                document.getElementById('stat-dogs').textContent = data.dogs || 0;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async loadDogs() {
            try {
                const response = await fetch('/api/dogs');
                if (!response.ok) return;
                const data = await response.json();
                this.dogs = Array.isArray(data) ? data : (data.dogs || []);
                this.populateDogFilter();
            } catch (error) {
                console.error('Error loading dogs:', error);
            }
        }

        populateDogFilter() {
            const select = document.getElementById('filter-dog');
            select.innerHTML = '<option value="">All Dogs</option>';
            this.dogs.forEach(dog => {
                const option = document.createElement('option');
                option.value = dog.id;
                option.textContent = dog.name;
                select.appendChild(option);
            });
        }

        async loadFingerprints() {
            try {
                const params = new URLSearchParams({
                    limit: this.pageSize,
                    offset: (this.currentPage - 1) * this.pageSize,
                    sort: this.sortColumn,
                    order: this.sortDirection
                });

                if (this.filters.dog_id) {
                    params.append('dog_id', this.filters.dog_id);
                }
                if (this.filters.tagged !== null) {
                    params.append('tagged', this.filters.tagged);
                }
                if (this.filters.date_start) {
                    params.append('date_start', this.filters.date_start);
                }
                if (this.filters.date_end) {
                    params.append('date_end', this.filters.date_end);
                }

                const response = await fetch(`/api/fingerprints?${params}`);
                if (!response.ok) {
                    this.renderEmptyState('Failed to load fingerprints');
                    return;
                }
                const data = await response.json();

                this.fingerprints = data.items || [];
                this.totalCount = data.total || this.fingerprints.length;
                this.renderFingerprints();
                this.updatePagination();
            } catch (error) {
                console.error('Error loading fingerprints:', error);
                this.renderEmptyState('Error loading fingerprints');
            }
        }

        renderFingerprints() {
            const tbody = document.getElementById('fingerprints-tbody');

            if (this.fingerprints.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7">
                            <div class="empty-state">
                                <svg class="empty-state-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <path d="M12 11c0 3.517-1.009 6.799-2.753 9.571m-3.44-2.04l.054-.09A13.916 13.916 0 008 11a4 4 0 118 0c0 1.017-.07 2.019-.203 3m-2.118 6.844A21.88 21.88 0 0015.171 17m3.839 1.132c.645-2.266.99-4.659.99-7.132A8 8 0 008 4.07M3 15.364c.64-1.319 1-2.8 1-4.364 0-1.457.39-2.823 1.07-4"/>
                                </svg>
                                <span class="empty-state-text">No fingerprints found.<br>Try adjusting your filters.</span>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            const html = this.fingerprints.map(fp => {
                const time = this.formatTime(new Date(fp.timestamp));
                const dog = fp.dog_id ? this.dogs.find(d => d.id === fp.dog_id) : null;
                const dogName = dog ? dog.name : null;

                // Confidence badge
                let confClass = 'low';
                const conf = fp.match_confidence || fp.detection_probability || 0;
                if (conf >= 0.8) confClass = 'high';
                else if (conf >= 0.5) confClass = 'medium';
                const confPercent = (conf * 100).toFixed(0) + '%';

                // Duration
                const duration = fp.duration_ms ? (fp.duration_ms / 1000).toFixed(2) + 's' : '--';

                // Pitch
                const pitch = fp.mean_pitch_hz ? Math.round(fp.mean_pitch_hz) + ' Hz' : '--';

                // Direction
                const direction = fp.doa_degrees !== null && fp.doa_degrees !== undefined
                    ? fp.doa_degrees + '\u00B0'
                    : '--';

                // Play button
                const playBtn = fp.evidence_filename
                    ? `<button class="action-btn action-btn--play" onclick="explorer.playAudio('${fp.evidence_filename}')" title="Play recording">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polygon points="5 3 19 12 5 21 5 3"/>
                        </svg>
                    </button>`
                    : '';

                return `
                    <tr>
                        <td class="mono">${this.escapeHtml(time)}</td>
                        <td>
                            ${dogName
                                ? `<span class="dog-tag">${this.escapeHtml(dogName)}</span>`
                                : `<span class="dog-tag dog-tag--unknown">Untagged</span>`
                            }
                        </td>
                        <td><span class="confidence-badge confidence-badge--${confClass}">${confPercent}</span></td>
                        <td class="mono">${duration}</td>
                        <td class="mono">${pitch}</td>
                        <td class="mono">${direction}</td>
                        <td>${playBtn}</td>
                    </tr>
                `;
            }).join('');

            tbody.innerHTML = html;
        }

        renderEmptyState(message) {
            const tbody = document.getElementById('fingerprints-tbody');
            tbody.innerHTML = `
                <tr>
                    <td colspan="7">
                        <div class="empty-state">
                            <svg class="empty-state-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <circle cx="12" cy="12" r="10"/>
                                <line x1="15" y1="9" x2="9" y2="15"/>
                                <line x1="9" y1="9" x2="15" y2="15"/>
                            </svg>
                            <span class="empty-state-text">${message}</span>
                        </div>
                    </td>
                </tr>
            `;
        }

        updatePagination() {
            const maxPage = Math.ceil(this.totalCount / this.pageSize) || 1;
            const start = (this.currentPage - 1) * this.pageSize + 1;
            const end = Math.min(this.currentPage * this.pageSize, this.totalCount);

            document.getElementById('pagination-info').textContent =
                this.totalCount > 0
                    ? `Showing ${start}-${end} of ${this.totalCount}`
                    : 'Showing 0-0 of 0';

            document.getElementById('pagination-page').textContent = `Page ${this.currentPage} of ${maxPage}`;

            document.getElementById('btn-prev').disabled = this.currentPage <= 1;
            document.getElementById('btn-next').disabled = this.currentPage >= maxPage;
        }

        async loadAggregates() {
            try {
                const response = await fetch('/api/fingerprints/aggregates');
                if (!response.ok) return;
                const data = await response.json();
                this.renderCharts(data);
            } catch (error) {
                console.error('Error loading aggregates:', error);
                // Render charts with empty data
                this.renderCharts({ by_dog: [] });
            }
        }

        async loadEvidence() {
            const listEl = document.getElementById('evidence-list');
            const countEl = document.getElementById('evidence-count');

            try {
                const response = await fetch('/api/evidence?count=20');
                if (!response.ok) {
                    listEl.innerHTML = '<div class="evidence-empty">Failed to load recordings</div>';
                    return;
                }
                const data = await response.json();
                const evidence = data.evidence || [];

                countEl.textContent = `${evidence.length} recordings`;

                if (evidence.length === 0) {
                    listEl.innerHTML = '<div class="evidence-empty">No recordings yet. Barks will be recorded automatically.</div>';
                    return;
                }

                listEl.innerHTML = evidence.map(ev => {
                    const time = new Date(ev.timestamp_local || ev.timestamp_utc);
                    const duration = ev.duration_seconds ? `${ev.duration_seconds.toFixed(1)}s` : '--';
                    const barks = ev.bark_count_in_clip || 0;
                    const prob = ev.peak_probability ? `${Math.round(ev.peak_probability * 100)}%` : '--';
                    const doa = ev.doa_degrees !== null ? `${ev.doa_degrees}¬∞` : '--';

                    return `
                        <div class="evidence-item">
                            <button class="evidence-play-btn" onclick="explorer.playEvidence('${ev.filename}', this)" title="Play recording">
                                <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16">
                                    <polygon points="5 3 19 12 5 21 5 3"/>
                                </svg>
                            </button>
                            <div class="evidence-info">
                                <div class="evidence-time">${this.formatTime(time)}</div>
                                <div class="evidence-meta">
                                    <span class="evidence-meta-item">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12">
                                            <circle cx="12" cy="12" r="10"/>
                                            <polyline points="12 6 12 12 16 14"/>
                                        </svg>
                                        ${duration}
                                    </span>
                                    <span class="evidence-meta-item">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12">
                                            <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
                                            <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                                        </svg>
                                        ${barks} bark${barks !== 1 ? 's' : ''}
                                    </span>
                                    <span class="evidence-meta-item">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12">
                                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                                            <polyline points="22 4 12 14.01 9 11.01"/>
                                        </svg>
                                        ${prob}
                                    </span>
                                    <span class="evidence-meta-item">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12">
                                            <circle cx="12" cy="12" r="10"/>
                                            <line x1="12" y1="2" x2="12" y2="12"/>
                                        </svg>
                                        ${doa}
                                    </span>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading evidence:', error);
                listEl.innerHTML = '<div class="evidence-empty">Error loading recordings</div>';
            }
        }

        playEvidence(filename, btnEl) {
            // Remove playing state from all buttons
            document.querySelectorAll('.evidence-play-btn.playing').forEach(b => b.classList.remove('playing'));

            const player = document.getElementById('audio-player');
            const audio = document.getElementById('audio-element');

            // Use Opus format for compressed web playback
            audio.src = `/api/evidence/${filename}?format=opus`;
            player.classList.add('active');
            btnEl.classList.add('playing');

            audio.play().catch(e => {
                // Fallback to WAV if Opus fails
                audio.src = `/api/evidence/${filename}`;
                audio.play();
            });

            // Remove playing state when audio ends
            audio.onended = () => btnEl.classList.remove('playing');
            audio.onpause = () => btnEl.classList.remove('playing');
        }

        renderCharts(data) {
            const byDog = data.by_dog || [];

            // Chart.js default dark theme configuration
            Chart.defaults.color = '#7d8590';
            Chart.defaults.borderColor = 'rgba(240, 246, 252, 0.1)';

            // Pitch Distribution Chart
            const pitchCtx = document.getElementById('pitch-chart').getContext('2d');
            if (this.pitchChart) this.pitchChart.destroy();

            const pitchLabels = byDog.map(d => d.dog_name || 'Unknown');
            const pitchData = byDog.map(d => d.avg_pitch_hz || 0);
            const pitchColors = this.generateColors(byDog.length);

            this.pitchChart = new Chart(pitchCtx, {
                type: 'bar',
                data: {
                    labels: pitchLabels,
                    datasets: [{
                        label: 'Avg Pitch (Hz)',
                        data: pitchData,
                        backgroundColor: pitchColors.map(c => c + '99'),
                        borderColor: pitchColors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Hz'
                            }
                        }
                    }
                }
            });

            // Duration Chart
            const durationCtx = document.getElementById('duration-chart').getContext('2d');
            if (this.durationChart) this.durationChart.destroy();

            const durationLabels = byDog.map(d => d.dog_name || 'Unknown');
            const durationData = byDog.map(d => (d.avg_duration_ms || 0) / 1000);

            this.durationChart = new Chart(durationCtx, {
                type: 'bar',
                data: {
                    labels: durationLabels,
                    datasets: [{
                        label: 'Avg Duration (s)',
                        data: durationData,
                        backgroundColor: pitchColors.map(c => c + '99'),
                        borderColor: pitchColors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Seconds'
                            }
                        }
                    }
                }
            });
        }

        generateColors(count) {
            const baseColors = [
                '#f59e0b', // amber
                '#14b8a6', // teal
                '#f85149', // coral
                '#58a6ff', // blue
                '#a855f7', // purple
                '#22c55e', // green
                '#ec4899', // pink
                '#06b6d4', // cyan
            ];
            const colors = [];
            for (let i = 0; i < count; i++) {
                colors.push(baseColors[i % baseColors.length]);
            }
            return colors;
        }

        async loadTimeline() {
            try {
                // Get fingerprints from last 24 hours for timeline
                const now = new Date();
                const yesterday = new Date(now - 24 * 60 * 60 * 1000);
                const params = new URLSearchParams({
                    limit: 200,
                    date_start: yesterday.toISOString().split('T')[0],
                    sort: 'timestamp',
                    order: 'asc'
                });

                const response = await fetch(`/api/fingerprints?${params}`);
                if (!response.ok) return;
                const data = await response.json();

                this.renderTimeline(data.fingerprints || [], yesterday, now);
            } catch (error) {
                console.error('Error loading timeline:', error);
            }
        }

        renderTimeline(fingerprints, startTime, endTime) {
            const timeline = document.getElementById('timeline');
            const totalMs = endTime - startTime;

            // Clear existing events (keep track)
            timeline.querySelectorAll('.timeline-event').forEach(el => el.remove());

            document.getElementById('timeline-start').textContent = this.formatTimeShort(startTime);
            document.getElementById('timeline-end').textContent = 'Now';

            fingerprints.forEach(fp => {
                const fpTime = new Date(fp.timestamp);
                const position = ((fpTime - startTime) / totalMs) * 100;
                if (position < 0 || position > 100) return;

                const event = document.createElement('div');
                event.className = 'timeline-event' + (fp.dog_id ? ' timeline-event--tagged' : '');
                event.style.left = position + '%';
                event.title = this.formatTime(fpTime) + (fp.dog_id ? ' (Tagged)' : '');
                timeline.appendChild(event);
            });
        }

        playAudio(filename) {
            const player = document.getElementById('audio-player');
            const audio = document.getElementById('audio-element');
            // Use Opus format for compressed web playback (50x smaller than WAV)
            audio.src = `/api/evidence/${filename}?format=opus`;
            player.classList.add('active');
            audio.play().catch(e => {
                // Fallback to WAV if Opus fails
                audio.src = `/api/evidence/${filename}`;
                audio.play();
            });
        }

        formatTime(date) {
            return date.toLocaleString('en-US', {
                month: 'short',
                day: 'numeric',
                hour: 'numeric',
                minute: '2-digit',
                second: '2-digit',
                hour12: true
            });
        }

        formatTimeShort(date) {
            return date.toLocaleString('en-US', {
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            });
        }

        escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    }

    // Global functions
    function closeAudioPlayer() {
        const player = document.getElementById('audio-player');
        const audio = document.getElementById('audio-element');
        audio.pause();
        audio.src = '';
        player.classList.remove('active');
    }

    // Initialize
    const explorer = new FingerprintsExplorer();
    </script>
</body>
</html>
